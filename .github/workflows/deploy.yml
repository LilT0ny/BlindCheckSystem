name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # 1. Navegar al directorio del proyecto
            cd ~/BlindCheck || exit 1
            
            # 2. Detener servicios que bloquean puertos 80 y 443
            echo "Stopping local web servers..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true

            # 3. Actualizar c√≥digo desde GitHub
            echo "Updating code from main..."
            git fetch --all
            git reset --hard origin/main

            # 4. Limpieza de Docker (Mantenimiento)
            echo "Cleaning up old Docker resources..."
            docker compose down --remove-orphans
            # Solo borramos im√°genes hu√©rfanas para no saturar el disco
            docker image prune -f 

            # 5. Gesti√≥n de Certificados SSL
            # Verificamos si existe el directorio de los certificados
            if [ ! -d "./certbot/conf/live/blindcheck.space" ]; then
              echo "‚ö†Ô∏è SSL: Certificados no encontrados. Iniciando script de inicializaci√≥n..."
              chmod +x init-letsencrypt.sh
              ./init-letsencrypt.sh
            else
              echo "‚úÖ SSL: Certificados encontrados y v√°lidos."
            fi

            # 6. Despliegue de la Aplicaci√≥n
            echo "üöÄ Levantando servicios con Docker Compose..."
            docker compose up -d --build

            # 7. Verificaci√≥n de estado
            echo "Final check..."
            sleep 5
            docker compose ps