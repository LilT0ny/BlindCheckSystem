name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # 1. Navegar al directorio y asegurar permisos
            cd ~/BlindCheck || exit 1
            sudo chown -R $USER:$USER ~/BlindCheck

            # 2. Detener servicios externos que chocan con puertos 80/443
            echo "Stopping conflicting services..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true

            # 3. Actualizar c√≥digo (Limpia cambios locales accidentales)
            echo "Syncing with GitHub..."
            git fetch --all
            git reset --hard origin/main

            # 4. Limpieza Profunda de Docker (Evita que el disco se llene)
            echo "Cleaning up Docker environment..."
            docker compose down --remove-orphans
            # Borra im√°genes viejas de m√°s de 24h para liberar espacio
            docker image prune -a -f --filter "until=24h"

            # 5. Gesti√≥n de Certificados SSL (Autom√°tico)
            if [ ! -d "./certbot/conf/live/blindcheck.space" ]; then
              echo "‚ö†Ô∏è SSL: No se detectaron certificados. Iniciando configuraci√≥n inicial..."
              chmod +x init-letsencrypt.sh
              ./init-letsencrypt.sh
            else
              echo "‚úÖ SSL: Certificados detectados."
            fi

            # 6. Despliegue y Re-construcci√≥n
            echo "üöÄ Lanzando contenedores..."
            docker compose up -d --build

            # 7. Verificaci√≥n de salud y Logs de error
            echo "Final verification..."
            sleep 10
            docker compose ps
            
            # Si el frontend no sube, nos muestra el error en los logs de GitHub
            if [ $(docker inspect -f '{{.State.Running}}' blindcheck-frontend) != "true" ]; then
              echo "‚ùå ERROR: El frontend fall√≥ al iniciar. Mostrando logs:"
              docker logs blindcheck-frontend
              exit 1
            fi
            echo "‚úÖ Despliegue completado con √©xito."